name: Deploy to Hostinger (SSH)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Lint PHP
        run: |
          set -e
          PHPS=$(find . -type f -name "*.php")
          if [ -n "$PHPS" ]; then
            for f in $PHPS; do php -l "$f"; done
          fi

      - name: Backup current release (server)
        uses: appleboy/ssh-action@v1
        with:
          host: 109.106.254.43
          username: u642727376
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            set -e
            ROOT=/home/u642727376/domains/sports-warehouse.reubenfraser.com/public_html
            BKDIR=/home/u642727376/domains/sports-warehouse.reubenfraser.com/_backups
            mkdir -p "$BKDIR"
            TS=$(date -u +'%Y%m%d-%H%M%S')
            tar -czf "$BKDIR/site-$TS.tgz" -C "$ROOT" .

      - name: Upload site via SCP
        uses: appleboy/scp-action@v1
        with:
          host: 109.106.254.43
          username: u642727376
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002

          source: |
            admin/**
            css/**
            js/**
            inc/**
            images/**
            uploads/**
            scripts/**
            sql/**
            src/**
            *.php

            # FORCE include of _deploy folder
            _deploy/.gitkeep:/_deploy/.gitkeep

            !**/.DS_Store
            !**/Thumbs.db

          target: /home/u642727376/domains/sports-warehouse.reubenfraser.com/public_html

      - name: Remove probe file
        uses: appleboy/ssh-action@v1
        with:
          host: 109.106.254.43
          username: u642727376
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: rm -f /home/u642727376/domains/sports-warehouse.reubenfraser.com/public_html/gha_probe.txt

      - name: Write deploy health marker
        uses: appleboy/ssh-action@v1
        with:
          host: 109.106.254.43
          username: u642727376
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 65002
          script: |
            set -e
            ROOT=/home/u642727376/domains/sports-warehouse.reubenfraser.com/public_html
            mkdir -p "$ROOT/_deploy"
            echo "deployed=$(date -u +'%Y-%m-%dT%H:%M:%SZ') sha=${GITHUB_SHA}" > "$ROOT/_deploy/health.txt"

      - name: Smoke test – homepage
        run: curl -fsSL https://sports-warehouse.reubenfraser.com/ >/dev/null

      - name: Smoke test – women (imgdebug off)
        run: curl -fsSL "https://sports-warehouse.reubenfraser.com/women" >/dev/null

      - name: Smoke test – women (imgdebug on)
        run: curl -fsSL "https://sports-warehouse.reubenfraser.com/women?imgdebug=1" >/dev/null

      - name: Smoke test – health marker
        run: curl -fsSL https://sports-warehouse.reubenfraser.com/_deploy/health.txt

      - name: Smoke test – 404
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" "https://sports-warehouse.reubenfraser.com/__nope__.txt")
          if [ "$code" != "404" ]; then
            echo "Expected 404, got $code"
            exit 1
          fi



